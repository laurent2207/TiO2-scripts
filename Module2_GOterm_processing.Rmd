# Script and session info
Script name: data_pre_processing.R

Purpose of script: pre-process GO-term genelists that will be used in: https://github.com/laurent2207/TiO2-scripts.
GO-term genelists: Apoptopic process (GO:0006915), Inflammatory response (GO:0006954)
GO-term genelists: Cellular response to DNA damage stimulus (GO:0006974), Cellular response to oxidative stress (GO:0034599)

Author: Laurent Winckers, Martina Kutmon

Date Created: 2020-03-23

## Session info:
R version 3.6.1 (2019-07-05)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 18362)
Packages: biomaRt_2.42.0

# Set up environment
```{r}
#clear workspace and set string as factors to false
rm(list=ls())
options(stringsAsFactors = F)

#set working directroy
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

# Install required packages and set up BioMart
```{r}
library(biomaRt)
library(clusterProfiler)
library(tidyr)
library(dplyr)
library(ggplot2)

biomart <- biomaRt::useEnsembl("ensembl", dataset = "hsapiens_gene_ensembl", host="uswest.ensembl.org")
```

# Define GO terms of interest
```{r}
go.terms <- c("GO:0006915","GO:0006954","GO:0006974","GO:0034599")
```

# Load genesets
```{r}
### load genesets
wp2gene <- clusterProfiler::read.gmt("data/gmt_wp_Homo_sapiens.gmt")
wp2gene <- wp2gene %>% tidyr::separate(ont, c("name","version","wpid","org"), "%")
wpid2gene <- wp2gene %>% dplyr::select(wpid,gene) #TERM2GENE
wpid2name <- wp2gene %>% dplyr::select(wpid,name) #TERM2NAME
```

# Create GO annotations for all GO terms of interest and run enrichment analysis
```{r}
source("functions/go_annotations.R")
source("functions/ora_enrichment.R")

for(i in go.terms) {
  res <- go_annotations(go.term = i, biomart = biomart, output = paste("output/",gsub(":", "", i),".txt", sep=""))
  ora_enrichment(genes = res$entrezgene_id, wpid2gene = wpid2gene, wpid2name = wpid2name, prefix = paste0(gsub(":", "", i), "_ORA"))
  # update workflow data file
  file.copy(from = paste("output/", gsub(":", "", i),".txt",sep=""), to = paste("data/",gsub(":", "", i),".txt",sep=""), overwrite = TRUE)
}

```